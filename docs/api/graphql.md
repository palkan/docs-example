# GraphQL API

GraphQL API is available at `/api/graphql`of the server.

[GraphiQL](https://github.com/graphql/graphiql) interface is available in development and staging environments only and accessible at `/graphiql`.

API documentation is generated automatically and available at `/docs/graphql`.

**NOTE:** documentation is protected by the Basic Auth authentication in production/staging envs.

## Errors & Exceptions

GraphQL endpoint **responds with "200 OK"** if server successfully processed the request
(i.e. if no unexpected exception occurred).

There are two types of errors that could happen: user input related (validations) and exceptions.

**Validations errors** may present **only in mutations** and are included into the data (i.e. `response.data.errors`) (using `ValidationErrors type`). They're meant to provide a useful feedback to user and could be displayed in the UI.

**Exceptions** could happen in any query and signalize that something went wrong with the query: for example, authentication/authorization issues, unprocessable input data, etc. (see below).
The client must "fail" when response contains an exception (e.g. show an error screen).

Client must check for `errors` field in the response to check for exceptions.

We add additional metadata to known exceptions via _errors extensions_:

```js
{
  "errors": [
    {
      "message": "Error message",
      // metadata
      "extensions": {
        // exception code (type) which could be used by client
        // to handle this exception
        "code": "under_scored_type"
        // optional
      }
    }
  ]
}
```

### Exceptions Codes

code                | description                                | reasons
--------------------|--------------------------------------------|------------
`unauthenticated`   | User is not authenticated (token is invalid or expired)  | `token_expired`, `invalid`
`not_found`         | Resource has not been found                |
`unauthorized`      | Authorization check failed (not enough persmissions)  | Instead of `"reason"` field it may contain `"fullMessages"` and `"details"` fields generated by the policy (see [Action Policy docs](https://actionpolicy.evilmartians.io/#/reasons))
`unprocessable_entity`  | The data sent by client is invalid or corrupted | `invalid_blob` (e.g. when Blob with the signed ID couldn't be found)

## Direct File Uploads

We provide direct uploads API for uploading files via API.

**NOTE**: "direct uploads" means that files uploaded directly to the storage service (e.g. S3),
without passing through the Rails app.

In order to upload a file a client must do the following steps:

- Obtain file metadata (filename, size, content type and **MD5 checksum encoded as base64**)
- Request direct upload credentials and `signed_blob_id` (or `id`) via API â€“ `createDirectUpload` mutation.
- Upload file using the credentials (no GraphQL involved, HTTP PUT request)
- (optional) Submit `signed_blob_id` as a mutation argument to "attach" the uploaded file to a record.

The required metadata for the file:

```js
{
  "checksum": "Eok7W9QzBmT+IrZFHQ8g2A==",
  "byteSize": 2011,
  "contentType": "image/png"
}
```

Resources:

- [Active Storage meets GraphQL: Direct Uploads](https://evilmartians.com/chronicles/active-storage-meets-graphql-direct-uploads)
- [Active Storage overview](https://edgeguides.rubyonrails.org/active_storage_overview.html#direct-uploads)
- [Rails JavaScript client for Active Storage with direct uploads support](https://github.com/rails/rails/tree/v6.0.0.beta3/activestorage/app/javascript/activestorage)
